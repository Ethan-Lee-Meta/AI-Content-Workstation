AI_SPECDIGEST:
  meta:
    artifact_id: "spec-<project>-<yyyymmdd>"
    version: "1.0.0"
    status: "frozen"  # draft|frozen
    language: "zh-CN"
    created_at: "<ISO8601>"
    owners:
      primary: "SpecAnalyst"
      approver: "User"
    fingerprints:
      spec_sha256: "<SPEC_SHA256_TBD>"
      conversation_ref: "<optional: chat id / link / note>"
    change_policy:
      frozen_immutable: true
      change_level: "CR-L1"
      owner_window: "ChangeCoordinator"
      change_flow:
        - "发现需求问题或新增需求 -> 生成 SPEC_CHANGE_REQUEST.yaml"
        - "提交至 Change Coordinator（窗口5）评估影响范围与传播路径"
        - "批准后提升 version，并更新 spec_sha256"
      note: "冻结后不得口头修改；以版本化变更为唯一通道"

  human_readable_doc:
    executive_summary:
      core_value: "在单机单用户环境下，实现AI图/视频生成→量化审核→资产入库→证据链追溯→按Shot编排引用→加密导出/迁移的闭环，并优先保证角色脸/风格一致性稳定。"
      target_users: "高频生成与复用AI素材的个人创作者/制片人/内容管线搭建者（单机单用户）。"
      key_differentiators:
        - "不可变证据链：Asset↔PromptPack↔Run↔Review↔Project/Series/Shot 的追溯与反向定位"
        - "量化审核：face/style/quality 分数 + overall_pass，支持自动通过+抽检与人工覆写留痕"
        - "可携带交付：可加密目录包，支持无导入预览与导入迁移（关系与证据链一致）"
    problem_statement: "生成素材分散、角色脸/风格不稳定、审核口径不统一、复用困难、交付/迁移缺乏可追溯证据链。"
    solution_statement: "以“资产库+关系管理+审核量化+证据链”为核心组织生成与复用；以Shot为单位做素材编排（仅引用关系）；支持加密导出与迁移。"
    non_goals_highlight:
      - "不做：多用户/权限/RBAC/协作"
      - "不做：NLE剪辑合成（转场/字幕/音轨/时间线渲染）"
      - "不做：模型训练/微调/LoRA训练管理"
      - "不做：云端同步/共享资产库（本期）"
      - "本规范不定义：数据库表结构、API字段名、具体库版本、路由/接口细节"
    glossary:
      - term: "Asset"
        definition: "系统管理的产出物（图片/视频）及其最小元数据与关联信息。"
      - term: "PromptPack"
        definition: "一次生成前由系统组装的提示词/输入集合的不可变快照（复制编辑产生新版本）。"
      - term: "Run"
        definition: "一次生成执行记录（包含输入引用、provider/workflow引用、状态与结果摘要）。"
      - term: "Review"
        definition: "对生成结果的质量/一致性审核记录（含分数、结论与原因）。"
      - term: "Evidence Chain"
        definition: "从输入到输出的可追溯记录：PromptPack/Run/Review/Asset等之间的关联链路。"
      - term: "Project"
        definition: "资产归类的顶层维度（可选；默认允许为空）。"
      - term: "Series"
        definition: "项目内的系列维度（可选；用于分组与编排）。"
      - term: "Shot"
        definition: "分镜头/顺序单元，用于按顺序引用0..N个素材（仅引用关系）。"
    personas:
      - id: "P1"
        name: "单机内容创作者"
        role: "生成与管理图/视频素材"
        context: "本地生成与整理素材，按系列/分镜做编排并交付/迁移"
        goals:
          - "快速生成可用素材并稳定一致"
          - "随时能找到并复用历史输入与结果"
          - "交付/迁移时关系与证据链不丢失"
        pain_points:
          - "素材分散、很难回溯当初怎么生成的"
          - "一致性不稳定导致返工"
          - "整理成本高"
    key_user_journeys:
      - id: "J1"
        name: "核心：生成并入库"
        steps:
          - "用户输入需求（可含脚本/分镜描述/参考图）"
          - "系统组装 PromptPack 快照"
          - "用户提交生成并等待完成"
          - "系统展示结果与运行信息"
          - "系统按默认策略审核（自动通过+抽检；必要时人工覆写）"
          - "资产入库并可追溯查看关联信息"
      - id: "J2"
        name: "核心：浏览资产并追溯复用"
        steps:
          - "用户在资产总览页查看全部图片/视频资产（无需先选Project/Series）"
          - "打开资产详情查看关联信息与证据链"
          - "从原始输入复用，形成新Run或新版本（概念层要求）"
    constraints_from_user:
      usability:
        - "前端交互层级尽量浅（避免深层嵌套）"
        - "高频操作支持批处理（批量选择/批量执行）"
        - "关键状态清晰可见（运行中/失败/可重试/已入库）"

  yaml_spec:
    scope:
      in:
        - id: "S1"
          name: "资产库管理（图片/视频）+ 总览页展示全部资产"
          priority: "P0"
          includes:
            - "至少一个页面（首页或资产库页）可展示全部图片与视频资产（无需先选Project/Series）"
            - "资产卡片展示关键字段，并提供进入资产详情的入口"
            - "资产详情可查看关联信息与追溯入口（PromptPack/Run/Review/Project/Series/Shot 等概念级信息）"
            - "支持删除（默认软删除）与回收站清空"
          excludes:
            - "不做：多用户/权限/RBAC/协作"
            - "不做：云端同步/共享资产库（本期）"
          future_candidates:
            - "多用户/多设备同步"
            - "更复杂的标签体系与检索推荐"
        - id: "S2"
          name: "四类生成入口（聊天式体验）"
          priority: "P0"
          includes:
            - "支持文生图、图生图、文生视频、图生视频四类生成入口（需求层覆盖）"
            - "输入可包含自然语言/脚本/分镜描述/参考图（概念层）"
            - "生成结果默认保存到资产库并可追溯"
          excludes:
            - "不锁定：具体provider、模型选择与参数细化（由ARCH/实现决定）"
          future_candidates:
            - "批量脚本化生成、模板化生成"
        - id: "S3"
          name: "一致性/质量审核 + 证据链（Traceability）"
          priority: "P0"
          includes:
            - "审核输出：face_consistency_score、style_consistency_score、quality_score、overall_pass、reasons[]（需求层语义冻结）"
            - "支持自动通过 + 抽检；支持人工覆写并写入原因（入证据链）"
            - "生成失败/审核未通过需记录原因并可重试，记录保留用于追溯"
          excludes:
            - "不锁定：自动打分算法实现方式（可先人工/规则）"
          future_candidates:
            - "更严格的自动评分与对比评测"
        - id: "S4"
          name: "按Shot编排引用 + 加密导出/无导入预览/导入迁移（闭环）"
          priority: "P1"
          includes:
            - "按Shot顺序编排：每个Shot引用0..N个素材（仅引用关系）"
            - "导出为可加密目录包（含资产本体+元数据+证据链+编排清单）"
            - "目录包无需导入即可浏览/预览（流式解密，最低预览能力由决策定义）"
            - "可导入新项目迁移且保留关系与证据链一致性（需求层）"
          excludes:
            - "不做：剪辑合成、转场、字幕、音轨、时间线渲染"
            - "不锁定：加密/流式解密实现细节（由ARCH/实现决定）"
          future_candidates:
            - "更丰富的时间线编辑/剪辑能力"
      out:
        - id: "O1"
          name: "多用户登录 + RBAC"
          reason: "本期单机单用户"
        - id: "O2"
          name: "NLE级剪辑合成与渲染输出"
          reason: "只做素材编排与引用关系"
        - id: "O3"
          name: "模型训练/微调/LoRA训练管理"
          reason: "范围聚焦素材生产与管理闭环"
        - id: "O4"
          name: "云端同步/共享资产库"
          reason: "本期单机单用户"
        - id: "O5"
          name: "复杂项目管理（排期/工时/看板）"
          reason: "不在MVP范围"

    users_and_operating_mode:
      collaboration_mode: "single_user_local"
      target_environments: ["web", "desktop"]
      ui_usability_constraints:
        - "核心任务（生成并查看结果）交互层级≤3"
        - "高频操作支持批处理"
        - "状态明确：运行状态、审核状态、入库状态清晰可见"

    workflows:
      - id: "WF1"
        name: "生成并入库（Happy Path）"
        steps:
          - "用户选择生成类型并提交"
          - "系统展示运行状态（进行中/成功/失败）"
          - "成功后展示结果与运行信息"
          - "按默认策略审核（自动通过+抽检 或 人工覆写）"
          - "资产入库并建立追溯关联"
        exceptions:
          - id: "EX-WF1-1"
            condition: "生成失败"
            expected_handling: "记录失败原因；允许重试；失败记录保留"
          - id: "EX-WF1-2"
            condition: "审核未通过"
            expected_handling: "记录原因；允许调整输入后重试；未通过记录保留"
      - id: "WF2"
        name: "浏览资产并追溯复用"
        steps:
          - "在总览页浏览全部资产并打开详情"
          - "查看关联信息与证据链节点"
          - "基于原始输入复用，形成新运行（概念层）"
      - id: "WF3"
        name: "编排并导出/导入迁移"
        steps:
          - "按Shot顺序编排引用（仅引用关系）"
          - "导出可加密目录包"
          - "无导入预览"
          - "导入迁移并保持关系与证据链一致性（需求层）"

    acceptance_criteria:
      - id: "AC-001"
        type: "functional"
        priority: "P0"
        title: "总览页可展示全部图片与视频并可进入详情"
        gherkin:
          given: "系统中至少存在1个图片资产与1个视频资产"
          when: "用户打开首页或资产库页面"
          then: "用户能看到覆盖全部资产的列表（包含图片与视频），并能打开任意资产详情"
      - id: "AC-002"
        type: "functional"
        priority: "P0"
        title: "资产详情具备关联信息与追溯入口"
        gherkin:
          given: "存在一个已入库资产"
          when: "用户打开资产详情"
          then: "能看到关联的PromptPack、Run、Review，以及Project/Series/Shot信息（如有）"
      - id: "AC-003"
        type: "functional"
        priority: "P0"
        title: "四类生成入口可发起生成且默认入库可追溯"
        gherkin:
          given: "用户提供生成输入并选择生成类型"
          when: "用户提交生成并等待完成"
          then: "结果可见且默认入库，并可追溯到PromptPack与Run"
      - id: "AC-004"
        type: "functional"
        priority: "P0"
        title: "审核输出量化分数与结论，支持自动通过+抽检与人工覆写留痕"
        checklist:
          - "审核至少输出：face_consistency_score、style_consistency_score、quality_score、overall_pass、reasons[]"
          - "通过项按默认比例抽检或标记通过；人工覆写必须填写原因并入证据链"
      - id: "AC-005"
        type: "usability"
        priority: "P1"
        title: "浅层交互完成核心任务"
        checklist:
          - "从首页完成“提交生成→查看结果”不超过3层页面/弹层"
      - id: "AC-006"
        type: "functional"
        priority: "P1"
        title: "导出目录包可无导入预览并可导入迁移（需求层）"
        checklist:
          - "导出后可无导入浏览/预览（最低预览能力见D-006）"
          - "导入后关系与证据链不丢失"

    decisions:
      - id: "D-001"
        topic: "Project/Series 是否必填"
        decision: "允许为空，生成后再归档。"
        rationale: "降低使用门槛，同时满足“总览页展示全部资产”。"
        impact: "需要支持未归档资产展示/筛选/归档入口（需求层）。"
        status: "confirmed"
      - id: "D-002"
        topic: "审核策略"
        decision: "自动通过 + 抽检。"
        status: "confirmed"
      - id: "D-003"
        topic: "抽检比例"
        decision: "通过项固定比例抽检（默认 5%）；新角色/新风格可提高比例（需求层）。"
        status: "confirmed"
      - id: "D-004"
        topic: "分数标尺与通过规则"
        decision: "分数标尺 0.00–1.00；overall_pass = (face>=Tf) AND (style>=Ts) AND (quality>=Tq)。"
        defaults:
          Tf: 0.80
          Ts: 0.80
          Tq: 0.70
        status: "confirmed"
      - id: "D-005"
        topic: "删除策略"
        decision: "默认软删除（回收站）+ 可清空。"
        status: "confirmed"
      - id: "D-006"
        topic: "无导入预览最低能力"
        decision: "至少提供缩略图/代理预览 + 元数据与关系/证据链只读浏览；视频可用封面抽帧；不承诺全质量实时播放。"
        status: "confirmed"

    non_functional_requirements:
      observability:
        requirements:
          - "关键动作（生成/审核/导出/删除/覆写）必须可追踪与可审计（概念层）。"
          - "必须存在健康检查能力（/health 概念存在；具体响应键由ARCH锁定）。"
          - "必须存在 request_id 追踪概念（header 名由ARCH锁定）。"
      performance:
        requirements:
          - "资产总览页与打开详情：用户操作后≤1s获得可见反馈（全量/分页策略由ARCH/实现决定）。"
          - "生成任务状态：秒级刷新可接受；不要求逐帧实时。"
      reliability:
        requirements:
          - "生成失败可重试且保留失败记录。"
          - "证据链记录不可静默覆盖；复用产生新运行/新版本（概念层）。"
      security:
        requirements:
          - "导出目录包必须可加密；密钥不得以明文形式与包一同存放。"
      usability:
        requirements:
          - "核心任务（生成并查看结果）交互层级≤3。"
          - "高频操作支持批处理。"
      compatibility:
        requirements:
          - "目标环境：web/desktop（具体OS/浏览器清单由ARCH确定）。"

    constraints:
      hard_stops:
        - "不得在需求阶段锁定数据库表结构、API字段名、具体库版本。"
        - "冻结后只能通过 CR-L1 变更。"

    assumptions:
      - "单机单用户。"
      - "MVP优先，后续通过CR演进。"

    open_questions: []

    traceability:
      scope_to_workflows:
        - scope_id: "S1"
          workflow_ids: ["WF2"]
        - scope_id: "S2"
          workflow_ids: ["WF1"]
        - scope_id: "S3"
          workflow_ids: ["WF1", "WF2"]
        - scope_id: "S4"
          workflow_ids: ["WF3"]
      scope_to_acceptance:
        - scope_id: "S1"
          acceptance_ids: ["AC-001", "AC-002"]
        - scope_id: "S2"
          acceptance_ids: ["AC-003"]
        - scope_id: "S3"
          acceptance_ids: ["AC-004"]
        - scope_id: "S4"
          acceptance_ids: ["AC-006"]

  handoff_summary:
    spec_version: "1.0.0"
    status: "frozen"
    spec_sha256: "<SPEC_SHA256_TBD>"
    downstream_must_receive:
      - "spec_version"
      - "status"
      - "spec_sha256"
