# ARCH_CONTRACT_SUMMARY.md — AI Content Workstation (v1.1.0, final)

## 0) Scope & Intent (aligned to AI_SPECDIGEST v1.1.0 frozen)
本版本架构契约面向 **单机单用户、本地优先** 的 AI 内容生成工作站，在 V1 “生成→审核→入库→追溯”闭环之上，冻结并交付 v1.1 的增量能力：
1) **提示词链路冻结（AC-008）**：`raw_input`（必有）→ `assembly_prompt`（可选）→ `final_prompt`（必有），且可从 Asset 详情反查。
2) **角色库 Characters（AC-007）**：角色实体 + 参考集版本化（ref_set），Generate 支持选角（含 primary），产物可追溯到角色与参考集版本。
3) **Settings / Providers（AC-010）**：前端可管理 ProviderProfile（配置实例），后端控制 ProviderType（能力类型清单与字段语义）；默认继承规则固定。

## 1) Hard Locks (machine-checkable)
- Ports：Web **2000**；API **7000**
- Health：`GET /health` 必含 keys：`status, version, db, storage, last_error_summary`
- Request-Id：输入/输出头 `X-Request-Id` 贯穿；错误响应也必须回写
- Error Envelope：固定 keys：`error, message, request_id, details`
- Pagination：`offset, limit`；响应 `{ items, page{ limit, offset, total, has_more } }`

## 2) Blueprint (text)
- Frontend：Next.js App Router；AppShell=Sidebar/Topbar(Omnibox)/MainContent/InspectorDrawer
- Backend：FastAPI；模块化 routers；中间件统一 request_id / error_envelope / health
- Data：SQLite（证据链与关系 SSOT）+ 本地 FS（资产 blobs、exports/imports 目录包）

## 3) v1.1 Contracts that MUST hold
### 3.1 Prompt Chain (PromptPack schema lock)
- PromptPack JSON 必含：`raw_input`（非空）、`final_prompt`（非空）、`assembly_used`（显式 bool）
- `assembly_prompt` 可缺省；缺省时 `assembly_used=false` 且 UI 必须显示 “未使用”
- PromptPack 为不可变快照（append-only）

### 3.2 Characters (ref_set versioning)
- Character 状态：`draft/confirmed/archived`
- confirmed 门槛冻结（写入 ref_set.snapshot）：**≥8 张**参考图（推荐 12）；可选短视频补充
- Run 必须记录：所选角色（0..N）+ primary 选择 + 本次使用的 `character_ref_set_id`（用于追溯与一致性评估）

### 3.3 Provider Settings (front-open / back-controlled)
- ProviderType：后端注册表输出支持清单 + 配置项语义（前端按语义渲染表单）
- ProviderProfile：前端可新增/编辑/设默认/删除；**secret 永不明文回显**（仅显示“已配置”状态）
- 默认继承：全局默认 → 工作区默认（Project/Series）→ 单次覆写（不反写默认）

## 4) Required Routes (UI IA lock)
`/library` `/assets/:asset_id` `/generate` `/trash` `/transfer` `/shots` `/projects` `/series` **新增** `/characters` `/settings`

## 5) Integration Strategy (parallel + merge safety)
- Backend stream（data_model + api_routes）：Characters/Providers/Runs 证据扩展
- Frontend stream（ui_routes + components）：/characters、/settings、Generate 与 Asset Detail 追溯增强
- Gates/Docs stream：为 AC-001..AC-010 保持可重复验证的证据输出；V1 基线不回归

## 6) Confirmations (user confirmed defaults)
- PC-001：Character 参考图作为普通 Asset 可见；通过 usage 标记支持过滤
- PC-002：API 永不明文返回 secret；DB 加密为实现选项（非强制）
- PC-003：v1.1 不强制模板化组装；先保证手写 assembly_prompt 可追溯
