# DEVELOPMENT_BATCHES.md (v1.1.0, draft) — AI Content Workstation

## 0) 指纹与冻结状态
- Inputs
  - AI_SPECDIGEST v1.1.0 (frozen) sha256: `cc7c290224a37ef3b92bc797de37e8e0148e7107959c8e1bf3e5373aeabf51a3`
  - ARCH_DIGEST v1.1.0 (frozen) sha256: `f83879ffdc5b1c191ad235cd046ebd28d008ba9677c45f554aebc60b4b0b9d00`
  - ARCH_CONTRACT_SUMMARY (final) sha256: `d0f06d7965c18479118bdb5653635e8b421fa4d5b1ba7871e3e10f78f68fc2bb`
  - REQ_CONTRACT_SUMMARY (final) sha256: `5dcf49e5b47acc255a715c1fa346b43fae9186b56ec08f0e8bb930d024e3dcad`
  - PROJECT_ANALYSIS_V1 sha256: `33360d40ac1ecee3b9ca97e032710e9d5b218e5ba3eca9127478f649aa9a8d2a`
- Outputs (this document): sha256 `<TBD: computed by gate/CI>`, status `draft`

## 1) 并行与合流原则
- 以冲突域拆分并行：`data_model` / `api_routes` / `ui_routes+components` / `gates+docs`
- 合流顺序遵守 O1~O5：
  - O1：门禁/可观测性/契约校验先行
  - O2：数据模型与迁移早于业务接口
  - O3：API 契约与路由早于 UI
  - O4：最小可用垂直切片尽早跑通
  - O5：扩展与优化后置
- 每个 Batch 交付必须满足：
  - 可独立合并（不依赖未合并代码）
  - 可独立验收（有可运行验证命令 + 明确预期）
  - 可回滚（能回到“最近一次 gates 全绿”的锚点）

## 2) 批次总览（Batch 0..8）

### Batch 0 — Baseline Preflight (O1)
- 目标：建立 v1.1 统一验证基线，确保 v1 不回归
- Steps：`STEP-010`
- 冲突域：observability_contract + gates
- 验证：`bash scripts/gate_all.sh --mode=preflight`

### Batch 1 — Data Model / Migrations (O2)
- 目标：引入 Characters / ProviderProfiles 存储骨架与迁移
- Steps：`STEP-020`
- 冲突域：data_model
- 依赖：Batch 0
- 验证：`bash scripts/gate_models.sh` + `bash scripts/gate_api_smoke.sh`

### Batch 2A — Provider Backend (O3)
- 目标：ProviderType registry + ProviderProfiles API（含 secrets 脱敏与默认唯一）
- Steps：`STEP-030` → `STEP-040`
- 冲突域：api_contract / api_routes
- 依赖：Batch 1
- 验证：`curl /provider_types` + `curl /provider_profiles?offset&limit` + `gate_api_smoke`

### Batch 2B — Characters Backend (O3)
- 目标：Characters API + ref_set 版本化 + 引用资产（>=8 confirmed 门槛）
- Steps：`STEP-050`
- 冲突域：api_contract / api_routes
- 依赖：Batch 1
- 验证：`curl /characters?offset&limit` + `gate_api_smoke`

### Batch 2C — Runs + Trace Backend (O3→O4)
- 目标：Runs 契约增强（PromptPack schema / characters primary / provider evidence）+ AssetDetail 追溯扩展
- Steps：`STEP-060` → `STEP-070`
- 冲突域：api_contract / api_routes
- 依赖：Batch 2A + Batch 2B
- 验证：`gate_api_smoke` + `gate_assets_read`

### Batch 3 — UI Routes Skeleton (IA lock)
- 目标：补齐 `/characters` `/characters/:id` `/settings` 路由（可占位但必须可访问）
- Steps：`STEP-080`
- 冲突域：ui_routes
- 依赖：Batch 0（最小依赖；允许与后端并行）
- 验证：`curl http://127.0.0.1:2000/characters` + `curl http://127.0.0.1:2000/settings` + `gate_web_routes`

### Batch 4A — Settings UI (O4)
- 目标：/settings 管理 ProviderProfiles（动态表单、脱敏、设默认）
- Steps：`STEP-090`
- 冲突域：ui_components
- 依赖：Batch 2A + Batch 3
- 验证：纳入 `gate_all --mode=full`（最终以 STEP-140 全量验收为准）

### Batch 4B — Characters UI (O4)
- 目标：/characters 管理角色与 ref_set 版本化；引用资产选择；>=8 门槛提示
- Steps：`STEP-100`
- 冲突域：ui_components
- 依赖：Batch 2B + Batch 3
- 验证：纳入 `gate_all --mode=full`

### Batch 5 — Generate UI Upgrade (O4)
- 目标：/generate 支持 PromptChain（组装可选）、角色选择+primary、provider 继承/覆写
- Steps：`STEP-110`
- 冲突域：ui_components
- 依赖：Batch 2C + Batch 4A + Batch 4B
- 验证：纳入 `gate_all --mode=full`

### Batch 6 — Library & AssetDetail UI Finalization (O4/O5)
- 目标：Library 过滤/排序（类型/来源/时间/状态）+ AssetDetail evidence chain 完整展示
- Steps：`STEP-120`
- 冲突域：ui_components
- 依赖：Batch 5（使用其产出的链路作为验证素材）+ Batch 2C
- 验证：纳入 `gate_all --mode=full`

### Batch 7 — Gates & Docs Closure (O1→O5 收口)
- 目标：新增 v1.1 专用 gates 并更新 EVIDENCE/HANDOFF
- Steps：`STEP-130`
- 冲突域：gates + docs
- 依赖：Batch 2C + Batch 4/5/6（功能面齐备后集中固化）
- 验证：`bash scripts/gate_all.sh --mode=full`

### Batch 8 — Release Candidate (Final)
- 目标：AC-001..AC-010 全量验收 + 回归
- Steps：`STEP-140`
- 冲突域：gates + docs
- 依赖：Batch 7
- 验证：`bash scripts/gate_all.sh --mode=full`

## 3) 合流节奏建议（减少冲突）
- 先合 Batch 0 → Batch 1（给后端并行提供稳定底座）
- 后端并行：Batch 2A 与 2B 可并行；完成后合并到 2C
- 前端并行：Batch 3 可尽早合并；Batch 4A/4B 并行；再进入 Batch 5/6
- Batch 7/8 作为收口与发布候选，不建议与大功能并行混合提交

## 4) 最小 Happy Path（用于集成验收）
- Provider：创建 ProviderProfile → 设全局默认（验证 secrets 脱敏）
- Characters：创建角色 → 创建 ref_set → 添加 >=8 引用资产 → confirmed → active_ref_set 生效
- Generate：选择 run_type（t2i/i2i/t2v/i2v）→ 填 raw_input/final_prompt（assembly 可选）→ 选择角色并标 primary → 覆写/继承 provider profile → 提交 run
- Trace：生成结果入库为 Asset → AssetDetail 反查 PromptChain/Run/Review/Character/ref_set/Provider

## 5) 回滚与故障隔离（批次级）
- 若某批次失败：
  - 优先回滚到“最近一次 gate_all --mode=preflight 全绿”的锚点
  - 若失败属于 UI：不回滚后端（避免破坏已稳定 API），通过 UI feature flag/降级显示先解除阻断
  - 若失败属于数据迁移：优先重建本地 DB 复现；确认后再做 VCS 回滚（避免数据污染造成误判）
